<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>schedd</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <link rel="stylesheet" href="assets/style.css">
</head>

<body>
  <div id="header">
    <img src="assets/logo.png" />
  </div>
  <div id="app_container">
    <script type="module">
      const server_url = document.location.hostname == 'localhost' || document.location.hostname == '' ? 'http://localhost:61919/' : 'https://hostname_not_configured/backend/';

      function load_url(url, callback, payload, failure_callback) {
        var xmlhttp;

        if (window.XMLHttpRequest)
          xmlhttp = new XMLHttpRequest();
        else
          xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");

        xmlhttp.onreadystatechange = function () {
          if (xmlhttp.readyState == 4) {
            if (xmlhttp.status >= 200 && xmlhttp.status < 300) {
              try {
                let obj = JSON.parse(xmlhttp.responseText);
                callback(obj);
              } catch (e) {
                failure_callback();
              }
            } else {
              failure_callback();
            }
          }
        }

        xmlhttp.ontimeout = (e) => {
          failure_callback();
        };

        xmlhttp.timeout = 7500;
        xmlhttp.open("POST", url, true);
        xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xmlhttp.send(JSON.stringify(payload));
      }

      function load_backend_url(url, callback, payload, failure_callback) {
        load_url(server_url + url, callback, payload, failure_callback);
      }
      
      function login_failure() {
        document.getElementById("login_failure").style.display = "block";
      };

      function registration_failure() {
        document.getElementById("registration_failure").style.display = "block";
      }

      function is_logged_in() {
        return (localStorage.getItem("session_token") != null);
      }
      
      function get_session_token() {
        return localStorage.getItem("session_token");
      }
      
      function set_session_token(token) {
        return localStorage.setItem("session_token", token);
      }
      
      function show_login_screen() {
        document.getElementsByClassName("login")[0].style.display = "block";

        document.getElementById("username-submit-button").addEventListener('click', function () {
          let usernameObject = { username: document.getElementById("username").value };
          
          function onLoginSuccess(obj) {
            set_session_token(obj.session_id);
            document.getElementsByClassName("login")[0].style.display = "none";
            show_user_schedule();
          };

          load_backend_url("login", onLoginSuccess, usernameObject, login_failure);
        });
        
        document.getElementById("create-account-button").addEventListener('click', function () {
          let usernameObject = { username: document.getElementById("new-username").value };

          function onRegistrationSuccess(obj) {
            set_session_token(obj.session_id);
            document.getElementsByClassName("login")[0].style.display = "none";
            show_user_schedule();
          };

          load_backend_url("registration", onRegistrationSuccess, usernameObject, registration_failure);
        });
      }

      function show_user_schedule() {
        document.getElementsByClassName("schedule")[0].style.display = "block";
      }

      window.addEventListener('load', () => {
        if (!is_logged_in()) {
          show_login_screen();
          return;
        }
        else {
          show_user_schedule();
        }
        
        // TODO: Enable / Display buttons only accessible when logged in?
        
        // TODO: Get Current Tasks / Progress / Whatsoever.
      });
    </script>

    <div class="login">
      <div class="box">
        <h1>Login</h1>
        <p>Please log in with your username.</p>
        <failure_message id="login_failure">
          <p>Login Failure!</p>
        </failure_message>
        <label for="username">Username</label></br>
        <input type="text" id="username"></input>
        <button id="username-submit-button">log in</button>
        <p><br>Or register with a new username.</p>
        <failure_message id="registration_failure">
          <p>Registration failure!</p>
        </failure_message>
        <label for="username">Username</label></br>
        <input type="text" id="new-username"></input>
        <button id="create-account-button">create new account</button>
      </div>
    </div>
    <div class="schedule">
      <div class="box">
        <h1>Your tasks for today</h1>
      </div>
    </div>
  </div>
</body>

</html>