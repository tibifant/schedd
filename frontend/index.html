<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>schedd</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <link rel="stylesheet" href="assets/style.css">
</head>

<body>
  <div id="header">
    <img src="assets/logo.png" />
  </div>
  <div id="app_container">
    <script type="module">
      const server_url = document.location.hostname == 'localhost' || document.location.hostname == '' ? 'http://localhost:61919/' : 'https://hostname_not_configured/backend/';

      function load_url(url, callback, payload, failure_callback) {
        var xmlhttp;

        if (window.XMLHttpRequest)
          xmlhttp = new XMLHttpRequest();
        else
          xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");

        xmlhttp.onreadystatechange = function () {
          if (xmlhttp.readyState == 4) {
            if (xmlhttp.status >= 200 && xmlhttp.status < 300) {
              try {
                let obj = JSON.parse(xmlhttp.responseText);
                callback(obj);
              } catch (e) {
                failure_callback();
              }
            } else {
              failure_callback();
            }
          }
        }

        xmlhttp.ontimeout = (e) => {
          failure_callback();
        };

        xmlhttp.timeout = 7500;
        xmlhttp.open("POST", url, true);
        xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xmlhttp.send(JSON.stringify(payload));
      }

      function load_backend_url(url, callback, payload, failure_callback) {
        load_url(server_url + url, callback, payload, failure_callback);
      }
      
      function login_failure() {
        document.getElementById("login_failure").style.display = "block";
      };

      function registration_failure() {
        document.getElementById("registration_failure").style.display = "block";
      }
      
      function task_creation_failure() {
        document.getElementById("task_creation_failure").style.display = "block";
      }

      function is_logged_in() {
        return (localStorage.getItem("session_token") != null);
      }
      
      function get_session_token() {
        return localStorage.getItem("session_token");
      }
      
      function set_session_token(token) {
        return localStorage.setItem("session_token", token);
      }
      
      function show_login_screen() {
        document.getElementsByClassName("login")[0].style.display = "block";

        document.getElementById("username-submit-button").addEventListener('click', function () {
          let usernameObject = { username: document.getElementById("username").value };
          
          function onLoginSuccess(obj) {
            set_session_token(obj.session_id);
            document.getElementsByClassName("login")[0].style.display = "none";
            show_task_creation();
          };

          load_backend_url("login", onLoginSuccess, usernameObject, login_failure);
        });
        
        document.getElementById("create-account-button").addEventListener('click', function () {
            document.getElementsByClassName("login")[0].style.display = "none";
            show_account_creation_screen();
        });
      }

      function show_account_creation_screen() {
        document.getElementsByClassName("user_registration")[0].style.display = "block";
        
        document.getElementById("submit_new_user_info_button").addEventListener('click', function () {
          let username = document.getElementById("new-username").value;

          let availableTime = [];
          availableTime[0] = document.getElementById("user_time_info_monday").value;
          availableTime[1] = document.getElementById("user_time_info_tuesday").value;
          availableTime[2] = document.getElementById("user_time_info_wendesday").value;
          availableTime[3] = document.getElementById("user_time_info_thursday").value;
          availableTime[4] = document.getElementById("user_time_info_friday").value;
          availableTime[5] = document.getElementById("user_time_info_saturday").value;
          availableTime[6] = document.getElementById("user_time_info_sunday").value;

          let newAccountObject = { "username": username, "availableTime": availableTime };

          function onRegistrationSuccess(obj) {
            set_session_token(obj.session_id);
            document.getElementsByClassName("user_registration")[0].style.display = "none";
            show_task_creation();
          };

          load_backend_url("registration", onRegistrationSuccess, newAccountObject, registration_failure);
        });

      }

      function show_task_creation() {
        document.getElementsByClassName("task-creation")[0].style.display = "block";

        document.getElementById("create-task-button").addEventListener('click', () => {
          let sessionToken = get_session_token();
          let taskName = document.getElementById("task-name").value;
          let taskDuration = document.getElementById("task-duration").value;
          let taskExecutionDays = [];
          taskExecutionDays[0] = document.getElementById("task-execution-days-monday").checked;
          taskExecutionDays[1] = document.getElementById("task-execution-days-tuesdays").checked;
          taskExecutionDays[2] = document.getElementById("task-execution-days-wendesday").checked;
          taskExecutionDays[3] = document.getElementById("task-execution-days-thursday").checked;
          taskExecutionDays[4] = document.getElementById("task-execution-days-friday").checked;
          taskExecutionDays[5] = document.getElementById("task-execution-days-saturday").checked;
          taskExecutionDays[6] = document.getElementById("task-execution-days-sunday").checked;
          let taskRepition = document.getElementById("task-repetition").value;
          let taskWeight = document.getElementById("task-weight").value;
          let taskWeightFactor = document.getElementById("task-weight-factor").value;

          let taskObject = { "sessionId": sessionToken, "name": taskName, "duration": taskDuration, "possibleExecutionDays": taskExecutionDays, "repetitionTimeSpan": taskRepition, "weight": taskWeight, "weightFactor": taskWeightFactor };

          function onTaskCreationSuccess(obj) {
            document.getElementById("task_creation_success").style.display = "block";
            //document.getElementsByClassName("task-creation")[0].style.display = "none";
            //show_user_schedule();
          }

          load_backend_url("task-creation", onTaskCreationSuccess, taskObject, task_creation_failure)
        })
      }

      function show_user_schedule() {
        document.getElementsByClassName("schedule")[0].style.display = "block";
      }

      window.addEventListener('load', () => {
        if (!is_logged_in()) {
          show_login_screen();
          return;
        }
        // TODO: Show the last used screen when reloading
        
        // TODO: Enable / Display buttons only accessible when logged in?

        // TODO: User must provide his available time per day (when registrating?)
        
        // TODO: Get Current Tasks / Progress / Whatsoever.
      });
    </script>

    <div class="login">
      <div class="box">
        <h1>Login</h1>
        <p>Please log in with your username.</p>
        <failure_message id="login_failure">
          <p>Login Failure!</p>
        </failure_message>
        <label for="username">Username</label></br>
        <input type="text" id="username"></input>
        <button id="username-submit-button">log in</button>
        <p><br>Or register with a new username.</p>
        <button id="create-account-button">create new account</button>
      </div>
    </div>
    <div class="user_registration">
      <div class="box">
          <p>Registration failure!</p>
        </failure_message>
        <label for="new-username">Username</label></br>
        <input type="text" id="new-username"></input>
        <button id="create-account-button">create new account</button>
        <p>On which days do you have how much available time for schedd-tasks?</p>
        <label for="user_time_info_monday">On Mondays (in minutes)</label></br>
        <input type="number" min="0" max="1440" id="user_time_info_monday"></input><br>
        <label for="user_time_info_tuesday">On Tuesdays (in minutes)</label></br>
        <input type="number" min="0" max="1440" id="user_time_info_tuesday"></input><br>
        <label for="user_time_info_wendesday">On Wendesdays (in minutes)</label></br>
        <input type="number" min="0" max="1440" id="user_time_info_wendesday"></input><br>
        <label for="user_time_info_thursday">On Thursdays (in minutes)</label></br>
        <input type="number" min="0" max="1440" id="user_time_info_thursday"></input><br>
        <label for="user_time_info_friday">On Friday (in minutes)</label></br>
        <input type="number" min="0" max="1440" id="user_time_info_friday"></input><br>
        <label for="user_time_info_saturday">On Saturdays (in minutes)</label></br>
        <input type="number" min="0" max="1440" id="user_time_info_saturday"></input><br>
        <label for="user_time_info_sunday">On Sundays (in minutes)</label></br>
        <input type="number" min="0" max="1440" id="user_time_info_sunday"></input><br>
        <button id="submit_new_user_info_button">submit</button>
      </div>
    </div>
    <div class="task-creation">
      <div class="box">
        <h1>Create a new task.</h1>
        <failure_message id="task_creation_failure">
          <p>Task Creation Failure!</p>
        </failure_message>
        <failure_message id="task_creation_success">
          <p>Success!</p>
        </failure_message>
        <label for="task-name">What's the name of the task?</label></br>
        <input type="text" id="task-name"></input></br>
        <label for="task-duration">How long does the task take? (in minutes)</label></br>
        <input type="number" min="1" max="1440" id="task-duration"></input></br> <!-- This should be handled differently-->
        <label>On which days can the task be executed?</label></br>
        <input type="checkbox" id="task-execution-days-monday">On Mondays</input></br>
        <input type="checkbox" id="task-execution-days-tuesdays">On Tuesdays</input></br>
        <input type="checkbox" id="task-execution-days-wendesday">On Wendesdays</input></br>
        <input type="checkbox" id="task-execution-days-thursday">On Thursdays</input></br>
        <input type="checkbox" id="task-execution-days-friday">On Fridays</input></br>
        <input type="checkbox" id="task-execution-days-saturday">On Saturdays</input></br>
        <input type="checkbox" id="task-execution-days-sunday">On Sundays</input></br>
        <label for="task-repetition">After which timespan should the task be repeated? (in days)</label></br> <!-- This needs to be handled differently, you should be able to repeat a task every monday and tuesday and stuff, also not in days-->
        <input type="number" min="0" id="task-repetition"></input><br>
        <label for="task-weight">How important is the task? (Number between 0 and 100)</label></br>
        <input type="number" min="0" max="100" id="task-weight"></input><br>
        <label for="task-weight-factor">How important is it that the task gets done as quickly as possible? (Number between 0 and 100)</label></br>
        <input type="number" min="0" max="100" id="task-weight-factor"></input><br>
        <button id="create-task-button">create new task</button>
      </div>
    </div>
    <div class="schedule">
      <div class="box">
        <h1>Your tasks for today</h1>
      </div>
    </div>
  </div>
</body>

</html>