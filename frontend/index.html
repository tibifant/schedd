<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>schedd</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <link rel="stylesheet" href="assets/style.css">
</head>

<body>
  <div id="header">
    <img src="assets/logo.png" />
  </div>
  <div id="app_container">
    <script type="module">
      const server_url = document.location.hostname == 'localhost' || document.location.hostname == '' ? 'http://localhost:61919/' : 'https://hostname_not_configured/backend/';

      function load_url(url, callback, payload, failure_callback) {
        var xmlhttp;

        if (window.XMLHttpRequest)
          xmlhttp = new XMLHttpRequest();
        else
          xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");

        xmlhttp.onreadystatechange = function () {
          if (xmlhttp.readyState == 4) {
            if (xmlhttp.status >= 200 && xmlhttp.status < 300) {
              try {
                let obj = JSON.parse(xmlhttp.responseText);
                callback(obj);
              } catch (e) {
                failure_callback();
              }
            } else {
              failure_callback();
            }
          }
        }

        xmlhttp.ontimeout = (e) => {
          failure_callback();
        };

        xmlhttp.timeout = 7500;
        xmlhttp.open("POST", url, true);
        xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xmlhttp.send(JSON.stringify(payload));
      }

      function load_backend_url(url, callback, payload, failure_callback) {
        load_url(server_url + url, callback, payload, failure_callback);
      }

///////////////////////////////////////////////////////////////////////////////////////

      function is_logged_in() {
        return (localStorage.getItem("session_token") != null);
      }
      
      function get_session_token() {
        return localStorage.getItem("session_token");
      }
      
      function set_session_token(token) {
        return localStorage.setItem("session_token", token);
      }

///////////////////////////////////////////////////////////////////////////////////////

      function append_element(parent, type, className, innerText) {
        const elem = document.createElement(type);
        elem.innerText = innerText;
        elem.className = className;
        parent.appendChild(elem);
        return elem;
      }
      
      function removeChildNodesByClass(parent, className) {
        var elements = parent.getElementsByClassName(className);

        for (let i = 0; i < elements.length; i++)
          elements[i].parentElement.removeChild(elements[i]);
      }

///////////////////////////////////////////////////////////////////////////////////////
      
      function show_login_screen() {
        document.getElementsByClassName("login")[0].style.display = "block";

        document.getElementById("username_submit_button").addEventListener('click', function () {
          let usernameObject = { username: document.getElementById("username").value };
          
          function onLoginSuccess(obj) {
            set_session_token(obj.session_id);
            document.getElementsByClassName("login")[0].style.display = "none";
            show_overview();
          };

          load_backend_url("login", onLoginSuccess, usernameObject, login_failure);
        });
        
        document.getElementById("create_account_button").addEventListener('click', function () {
            document.getElementsByClassName("login")[0].style.display = "none";
            show_account_creation_screen();
        });
      }
      
      function login_failure() {
        document.getElementById("login_failure").style.display = "block";
      };

///////////////////////////////////////////////////////////////////////////////////////

      function show_account_creation_screen() {
        document.getElementsByClassName("user_registration")[0].style.display = "block";
        
        document.getElementById("submit_new_user_info_button").addEventListener('click', function () {
          let username = document.getElementById("new_username").value;

          let availableTime = [];
          availableTime[0] = document.getElementById("user_time_info_monday").value;
          availableTime[1] = document.getElementById("user_time_info_tuesday").value;
          availableTime[2] = document.getElementById("user_time_info_wendesday").value;
          availableTime[3] = document.getElementById("user_time_info_thursday").value;
          availableTime[4] = document.getElementById("user_time_info_friday").value;
          availableTime[5] = document.getElementById("user_time_info_saturday").value;
          availableTime[6] = document.getElementById("user_time_info_sunday").value;

          let newAccountObject = { "username": username, "availableTime": availableTime };

          function onRegistrationSuccess(obj) {
            set_session_token(obj.session_id);
            document.getElementsByClassName("user_registration")[0].style.display = "none";
            show_overview();
          };

          load_backend_url("registration", onRegistrationSuccess, newAccountObject, registration_failure);
        });

      }

      function registration_failure() {
        document.getElementById("registration_failure").style.display = "block";
      }

///////////////////////////////////////////////////////////////////////////////////////

      function show_overview() {
        document.getElementsByClassName("overview")[0].style.display = "block";
        show_user_schedule();
        show_task_search();

        document.getElementById("show_add_task_button").addEventListener('click', () => {
          show_task_creation();
        });
      }

///////////////////////////////////////////////////////////////////////////////////////

      function show_task_creation() {
        document.getElementsByClassName("task_creation")[0].style.display = "block";

        let userSearchResults = user_search();

        function submit_new_task() {
          let sessionToken = get_session_token();
          let taskName = document.getElementById("task_name").value;
          let taskDuration = document.getElementById("task_duration").value;
          let taskExecutionDays = [];
          taskExecutionDays[0] = document.getElementById("task_execution_days_monday").checked;
          taskExecutionDays[1] = document.getElementById("task_execution_days_tuesdays").checked;
          taskExecutionDays[2] = document.getElementById("task_execution_days_wendesday").checked;
          taskExecutionDays[3] = document.getElementById("task_execution_days_thursday").checked;
          taskExecutionDays[4] = document.getElementById("task_execution_days_friday").checked;
          taskExecutionDays[5] = document.getElementById("task_execution_days_saturday").checked;
          taskExecutionDays[6] = document.getElementById("task_execution_days_sunday").checked;
          let taskRepition = document.getElementById("task_repetition").value;
          let taskWeight = document.getElementById("task_weight").value;
          let taskWeightFactor = document.getElementById("task_weight_factor").value;
          
          let taskObject = { "name": taskName, "duration": taskDuration, "possibleExecutionDays": taskExecutionDays, "repetitionTimeSpan": taskRepition, "weight": taskWeight, "weightFactor": taskWeightFactor, "userIds": userSearchResults };
          
          function onTaskCreationSuccess(obj) {
            document.getElementsByClassName("task_creation")[0].style.display = "none";
          }

          load_backend_url("task-creation", onTaskCreationSuccess, taskObject, task_creation_failure)
        }

        document.getElementById("create_task_button").addEventListener('click', () => {
          submit_new_task()
        })
      }
      
      function task_creation_failure() {
        document.getElementById("task_creation_failure").style.display = "block";
      }

///////////////////////////////////////////////////////////////////////////////////////

      function user_search() {
        // Clear list!
        document.getElementById('user_search_results').innerHTML = '';

        let selectedSearchResults = [];

        document.getElementById('submit_user_search_button').addEventListener('click', () => {
          // Clear list when searching again!
          document.getElementById('user_search_results').innerHTML = '';

          let input = document.getElementById("user_search_input").value;
          load_backend_url('user-search', onUserSearchSuccess, { 'input': input }, user_search_failure);
        });

        function onUserSearchSuccess(obj) {
          document.getElementById('task_search_failure').style.display = 'none';

          for (let i = 0; i < obj.length; i++) {
            let elem = append_element(document.getElementById('user_search_results'), 'li', '', obj[i].name);
            
            (() => {
              let u = obj[i];
              let idx = i;
              const isSelectedColor = '#a8a8a8';

              for (const s of selectedSearchResults)
                if (u.id == s)
                  elem.style.color = isSelectedColor;

              elem.onclick = () => {
                if (selectedSearchResults.includes(u.id)) {
                  selectedSearchResults.splice(idx, 1);
                  elem.style.color = '#fff';
                } else {
                  selectedSearchResults.push(u.id);
                  elem.style.color = isSelectedColor;
                }
              };
            })();
          }
        }

        return selectedSearchResults;
      }

      function user_search_failure() {
        document.getElementById('user_search_failure').style.display = "block";
      }

///////////////////////////////////////////////////////////////////////////////////////

      function show_task_done(id) {
        load_backend_url('task-done', onTaskDoneSuccess, { "sessionId": get_session_token(), "taskId": id }, task_done_failure)

        function onTaskDoneSuccess(obj) {
        document.getElementById('task_done_failure').style.display = 'none';
          document.getElementById('success').style.display = 'block';
        }
      }

      function task_done_failure() {
        document.getElementById('task_done_failure').style.display = 'block';
      }

///////////////////////////////////////////////////////////////////////////////////////

      function show_user_schedule() {
        load_backend_url("user-schedule", onGetCurrentTasksSuccess, { "sessionId": get_session_token() }, user_schedule_failure)
      
        function onGetCurrentTasksSuccess(obj) {
          document.getElementById('user_schedule_failure').style.display = 'none';
          document.getElementsByClassName('schedule')[0].style.display = 'block';

          let parent = document.getElementById('current_tasks');
          for (const item of obj) {
            let name = item.name;
            let duration = item.duration;
            let elem = append_element(parent, 'li', '', name + ' (' +  duration + ' minutes)');

            (() => {
              let i = item;

              elem.onclick = () => {
                show_task(i.id);
              };
            })();
          }
        }
      }

      function user_schedule_failure() {
        document.getElementById('user_schedule_failure').style.display = 'block';
      }

///////////////////////////////////////////////////////////////////////////////////////

      function show_task_search() {
        document.getElementsByClassName('task_search')[0].style.display = 'block';
        
        document.getElementById("submit_event_search_button").addEventListener('click', () => {
          // Clear list when searching again!
          document.getElementById('task_search_results').innerHTML = '';

          let input = document.getElementById("task_search_input").value;
          let searchObj = { "input": input };
          load_backend_url("task-search", onTaskSearchSuccess, searchObj, task_search_failure);
        });

        function onTaskSearchSuccess(obj) {
          document.getElementById('task_search_failure').style.display = 'none';

          for (const item of obj) {
            let name = item.name;
            let duration = item.duration;
            let elem = append_element(document.getElementById('task_search_results'), 'li', '', name + ' (' +  duration + ' minutes)');
            
            (() => {
              let i = item;

              elem.onclick = () => {
                show_task(i.id);
              };
            })();
          }
        }
      }

      function task_search_failure() {
        document.getElementById('task_search_failure').style.display = 'block';
      }

///////////////////////////////////////////////////////////////////////////////////////

      function show_task(taskId) {
        document.getElementsByClassName('task')[0].style.display = 'block';
        
        load_backend_url('task', onTaskDetailsSuccess, { 'taskId': taskId }, task_details_failure);

        function onTaskDetailsSuccess(obj) {
          document.getElementById('task_details_failure').style.display = 'none';

          // Set values of chosen task
          document.getElementById("task_name_edit").value = obj.name;
          document.getElementById("task_duration_edit").value = obj.duration;
          document.getElementById("task_execution_days_monday_edit").checked = obj.executionDays[0];
          document.getElementById("task_execution_days_tuesdays_edit").checked = obj.executionDays[1];
          document.getElementById("task_execution_days_wendesday_edit").checked = obj.executionDays[2];
          document.getElementById("task_execution_days_thursday_edit").checked = obj.executionDays[3];
          document.getElementById("task_execution_days_friday_edit").checked = obj.executionDays[4];
          document.getElementById("task_execution_days_saturday_edit").checked = obj.executionDays[5];
          document.getElementById("task_execution_days_sunday_edit").checked = obj.executionDays[6];
          document.getElementById("task_repetition_edit").value = obj.repetition;
          document.getElementById("task_weight_edit").value = obj.weight;
          document.getElementById("task_weight_factor_edit").value = obj.weightFactor;

          let userIds = [];

          // List clean-up
          document.getElementById('task_users_edit').innerHTML = '';

          for (let i = 0; i < obj.users.length; i++) {
            let elem = append_element(document.getElementById('task_users_edit'), 'li', '', obj.users[i].name);
            const isSelectedColor = '#a8a8a8';
            elem.style.color = isSelectedColor;
            
            (() => {
              let idx = i;
              let u = obj.users[i];
              userIds.push(u.id);

              elem.onclick = () => {
                if (userIds.includes(u.id)) {
                  userIds.splice(idx, 1);
                  elem.style.color = '#fff';
                } else {
                  userIds.push(u.id);
                  elem.style.color = isSelectedColor;
                }
              };           
            })();
          }

          document.getElementById("show_user_search_task_edit_button").addEventListener('click', () => {
            userIds = userIds.concat(user_search());
          });

          document.getElementById("edit_task_button").addEventListener('click', () => {
            document.getElementsByClassName('user_search')[0].style.display = 'none';
            submit_task_modification(taskId, userIds);
          });
        }

        document.getElementById("mark_as_done_button").addEventListener('click', () => {
          show_task_done(id);
        });
      }

      function task_details_failure() {
        document.getElementById('task_details_failure').style.display = 'block';
      }

///////////////////////////////////////////////////////////////////////////////////////

      function submit_task_modification(taskId, userIds) {
        let sessionToken = get_session_token();
        let taskName = document.getElementById("task_name_edit").value;
        let taskDuration = document.getElementById("task_duration_edit").value;
        let taskExecutionDays = [];
        taskExecutionDays[0] = document.getElementById("task_execution_days_monday_edit").checked;
        taskExecutionDays[1] = document.getElementById("task_execution_days_tuesdays_edit").checked;
        taskExecutionDays[2] = document.getElementById("task_execution_days_wendesday_edit").checked;
        taskExecutionDays[3] = document.getElementById("task_execution_days_thursday_edit").checked;
        taskExecutionDays[4] = document.getElementById("task_execution_days_friday_edit").checked;
        taskExecutionDays[5] = document.getElementById("task_execution_days_saturday_edit").checked;
        taskExecutionDays[6] = document.getElementById("task_execution_days_sunday_edit").checked;
        let taskRepition = document.getElementById("task_repetition_edit").value;
        let taskWeight = document.getElementById("task_weight_edit").value;
        let taskWeightFactor = document.getElementById("task_weight_factor_edit").value;

        let taskObject = { "id": taskId, "name": taskName, "duration": taskDuration, "possibleExecutionDays": taskExecutionDays, "repetitionTimeSpan": taskRepition, "weight": taskWeight, "weightFactor": taskWeightFactor, "userIds": userIds };

        function onTaskEditSuccess(obj) {
          document.getElementsByClassName("task")[0].style.display = "none";
        }

        load_backend_url("task-edit", onTaskEditSuccess, taskObject, task_edit_failure)
      }

      function task_edit_failure() {
        document.getElementById('task_edit_failure').style.display = 'block';
      }

///////////////////////////////////////////////////////////////////////////////////////

      window.addEventListener('load', () => {
        if (!is_logged_in()) {
          show_login_screen();
          return;
        }
        else {
          show_overview();
        }
        
        // TODO: Get Current Tasks / Progress / Whatsoever.
      });
    </script>

    <div class="login">
      <div class="box">
        <h1>Login</h1>
        <p>Please log in with your username.</p>
        <failure_message id="login_failure">
          <p>Login Failure!</p>
        </failure_message>
        <label for="username">Username</label></br>
        <input type="text" id="username"></input>
        <button id="username_submit_button">log in</button>
        <p><br>Or register with a new username.</p>
        <button id="create_account_button">create new account</button>
      </div>
    </div>
    <div class="user_registration">
      <div class="box">
        <h1>Create a new account</h1>
        <failure_message id="registration_failure">
          <p>Registration failure!</p>
        </failure_message>
        <label for="new_username">Username</label></br>
        <input type="text" id="new_username"></input>
        <h2>How much available time for schedd_tasks do you have on each day?</h2>
        <label for="user_time_info_monday">On Mondays (in minutes)</label></br>
        <input type="number" min="0" max="1440" id="user_time_info_monday"></input><br>
        <label for="user_time_info_tuesday">On Tuesdays (in minutes)</label></br>
        <input type="number" min="0" max="1440" id="user_time_info_tuesday"></input><br>
        <label for="user_time_info_wendesday">On Wendesdays (in minutes)</label></br>
        <input type="number" min="0" max="1440" id="user_time_info_wendesday"></input><br>
        <label for="user_time_info_thursday">On Thursdays (in minutes)</label></br>
        <input type="number" min="0" max="1440" id="user_time_info_thursday"></input><br>
        <label for="user_time_info_friday">On Friday (in minutes)</label></br>
        <input type="number" min="0" max="1440" id="user_time_info_friday"></input><br>
        <label for="user_time_info_saturday">On Saturdays (in minutes)</label></br>
        <input type="number" min="0" max="1440" id="user_time_info_saturday"></input><br>
        <label for="user_time_info_sunday">On Sundays (in minutes)</label></br>
        <input type="number" min="0" max="1440" id="user_time_info_sunday"></input><br>
        <button id="submit_new_user_info_button">Submit</button>
      </div>
    </div>
    <div class="task_creation">
      <div class="box">
        <h1>Create a new task.</h1>
        <failure_message id="task_creation_failure">
          <p>Task Creation Failure!</p>
        </failure_message>
        <label for="task_name">What's the name of the task?</label></br>
        <input type="text" id="task_name"></input></br>
        <label for="task_duration">How long does the task take? (in minutes)</label></br>
        <input type="number" min="1" max="1440" id="task_duration"></input></br> <!-- This should be handled differently -->
        <label>On which days can the task be executed?</label></br>
        <input type="checkbox" id="task_execution_days_monday">On Mondays</input></br>
        <input type="checkbox" id="task_execution_days_tuesdays">On Tuesdays</input></br>
        <input type="checkbox" id="task_execution_days_wendesday">On Wendesdays</input></br>
        <input type="checkbox" id="task_execution_days_thursday">On Thursdays</input></br>
        <input type="checkbox" id="task_execution_days_friday">On Fridays</input></br>
        <input type="checkbox" id="task_execution_days_saturday">On Saturdays</input></br>
        <input type="checkbox" id="task_execution_days_sunday">On Sundays</input></br>
        <label for="task_repetition">After which timespan should the task be repeated? (in days)</label></br> <!-- This needs to be handled differently, you should be able to repeat a task every monday and tuesday and stuff, also not in days -->
        <input type="number" min="0" id="task_repetition"></input><br>
        <label for="task_weight">How important is the task? (Number between 0 and 100)</label></br>
        <input type="number" min="0" max="100" id="task_weight"></input><br>
        <label for="task_weight_factor">How important is it that the task gets done as quickly as possible? (Number between 0 and 100)</label></br>
        <input type="number" min="0" max="100" id="task_weight_factor"></input><br>
        <failure_message id="user_search_failure">
          <p>User Search Failure!</p>
        </failure_message>
        <label for="user_search_input">Search for users and click in their name to assign them to the task</label></br>
        <input type="text" id="user_search_input"></input>
        <button id="submit_user_search_button">search</button><br>
        <ul id="user_search_results"></ul>
        <button id="create_task_button">create new task</button>
      </div>
    </div>
    <div class="overview">
      <div class="box">
        <h1>Welcome to Schedd!</h1>
        <button id="show_add_task_button">Add new Task</button>
        <failure_message id="task_done_failure">
          <p>Mark Task as done Failure!</p>
        </failure_message>
        <failure_message id="success">
          <p>SUCCESS!</p>
        </failure_message>
      </div>
    </div>
    <div class="task">
      <div class="box">
        <failure_message id="show_task_failure">
          <p>Failure!</p>
        </failure_message>
        <failure_message id="task_details_failure">
          <p>Failure Loading Task Details!</p>
        </failure_message>
        <failure_message id="task_edit_failure">
          <p>Failure Submitting Changes!</p>
        </failure_message>
        <!-- task details -->
        <button id="mark_as_done_button">Mark as Done</button></br></br>
        <p>You can edit the details.</p>
        <label for="task_name_edit">What's the name of the task?</label>
        <input type="text" id="task_name_edit"></input></br>
        <label for="task_duration_edit">How long does the task take? (in minutes)</label>
        <input type="number" min="1" max="1440" id="task_duration_edit"></input></br> <!-- This should be handled differently -->
        <label>On which days can the task be executed?</label></br>
        <input type="checkbox" id="task_execution_days_monday_edit">On Mondays</input></br>
        <input type="checkbox" id="task_execution_days_tuesdays_edit">On Tuesdays</input></br>
        <input type="checkbox" id="task_execution_days_wendesday_edit">On Wendesdays</input></br>
        <input type="checkbox" id="task_execution_days_thursday_edit">On Thursdays</input></br>
        <input type="checkbox" id="task_execution_days_friday_edit">On Fridays</input></br>
        <input type="checkbox" id="task_execution_days_saturday_edit">On Saturdays</input></br>
        <input type="checkbox" id="task_execution_days_sunday_edit">On Sundays</input></br>
        <label for="task_repetition_edit">After which timespan should the task be repeated? (in days)</label> <!-- This needs to be handled differently, you should be able to repeat a task every monday and tuesday and stuff, also not in days -->
        <input type="number" min="0" id="task_repetition_edit"></input><br>
        <label for="task_weight_edit">How important is the task? (Number between 0 and 100)</label>
        <input type="number" min="0" max="100" id="task_weight_edit"></input><br>
        <label for="task_weight_factor_edit">How important is it that the task gets done as quickly as possible? (Number between 0 and 100)</label>
        <input type="number" min="0" max="100" id="task_weight_factor_edit"></input><br>
        <p>Assigned Users:</p>
        <failure_message id="user_search_failure">
          <p>User Search Failure!</p>
        </failure_message>
        <label for="user_search_input_edit">Search for users and click in their name to assign them to the task</label></br>
        <input type="text" id="user_search_input_edit"></input>
        <button id="submit_user_search_button_edit">search</button><br>
        <ul id="user_search_results_edit"></ul>
        <button id="edit_task_button">Submit changes</button><br>
      </div>
    </div>
    <div class="task_search">
      <div class="box">
        <failure_message id="task_search_failure">
          <p>Task Search Failure!</p>
        </failure_message>
        <label for="task_search_input">Search for a task</label></br>
        <input type="text" id="task_search_input"></input>
        <button id="submit_event_search_button">search</button><br>
        <ul id="task_search_results"></ul>
      </div>
    </div>
    <div class="schedule">
      <div class="box">
        <h1>Your tasks for today</h1>
        <failure_message id="user_schedule_failure">
          <p>Failure Loading Tasks!</p>
        </failure_message>
        <failure_message id="user_schedule_empty">
          <p>No tasks for today!</p>
        </failure_message>
        <ul id="current_tasks"></ul>
      </div>
    </div>
  </div>
</body>

</html>